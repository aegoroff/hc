<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" ToolsVersion="12.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
    <!-- http://code.google.com/p/msbuildteamcitytasks/ -->
    <Import Project="$(MSBuildThisFileDirectory)\packages\msbuildteamcitytasks.2.4.260.0\tools\MSBuild.TeamCity.Tasks.Targets"/>
    <PropertyGroup>
        <Configuration>Release</Configuration>
        <!-- Version components  -->
        <Major>1</Major>
        <Minor>0</Minor>
        <Build>0</Build>
        <Revision>0</Revision>
        <IsUpload>false</IsUpload>
        <MultiProcessorCompilation>true</MultiProcessorCompilation>
        
        <!-- NSIS installer's path  -->
        <NSISPath>$(NSIS_ROOT)</NSISPath>
        
        <!-- binplace utility path  -->
        <BinPlacePath>$(WINDDK)\bin\x86</BinPlacePath>
        <SymStorePath>$(WINDDK)\Debuggers\x64</SymStorePath>
        
        <x86ExeFileSuffix>.exe</x86ExeFileSuffix>
        <PdbZipFile>Pdb.zip</PdbZipFile>
    </PropertyGroup>
    <ItemGroup>
        <ResourceFile Include="$(MSBuildProjectDirectory)\apc\apc.rc" />
        <ResourceFile Include="$(MSBuildProjectDirectory)\hlinq\hlinq.rc" />
    </ItemGroup>
    <ItemGroup>
        <TargetverFile Include="$(MSBuildProjectDirectory)\apc\targetver.h" />
        <TargetverFile Include="$(MSBuildProjectDirectory)\hlinq\targetver.h" />
    </ItemGroup>
    <Target Name="VersionUpdater">
        <BlockOpen Name="Preparation"/>
        <ItemGroup>
            <ResourceFiles Include="@(ResourceFile)">
			    <Find><![CDATA[VALUE\s*"(FileVersion|ProductVersion)",\s*"\d+([.,]\s*)\d+([.,]\s*)\d+([.,]\s*)\d+"]]></Find>
			    <ReplaceWith><![CDATA[VALUE "$1", "$(Major), $(Minor), $(Build), $(Revision)"]]></ReplaceWith>
			    <Options>Singleline</Options>
		    </ResourceFiles>
            <ResourceFiles Include="@(ResourceFile)">
                <Find><![CDATA[(FILEVERSION|PRODUCTVERSION)(\s*)(\d+),(\d+),(\d+),(\d+)]]></Find>
                <ReplaceWith><![CDATA[$1 $(Major),$(Minor),$(Build),$(Revision)]]></ReplaceWith>
                <Options>Singleline</Options>
            </ResourceFiles>
            <ResourceFiles Include="@(TargetverFile)">
                <Find><![CDATA[(#define PRODUCT_VERSION)(\s*)"(\d+).(\d+).(\d+).(\d+)"]]></Find>
                <ReplaceWith><![CDATA[$1 "$(Major).$(Minor).$(Build).$(Revision)"]]></ReplaceWith>
                <Options>Singleline</Options>
            </ResourceFiles>
		</ItemGroup>
        <RegexTransform Items="@(ResourceFiles)" />
        <BlockClose Name="Preparation"/>
    </Target>
    <ItemGroup>
        <Platform Include="Win32"/>
        <Platform Include="x64"/>
    </ItemGroup>
    <Target Name="Compile" DependsOnTargets="VersionUpdater">
        <ItemGroup>
            <NetPgoProject1 Include="$(MSBuildProjectDirectory)\doc.gen\doc.gen.csproj" />
            <NetPgoProject1 Include="$(MSBuildProjectDirectory)\bf.gui\bf.gui.csproj" />
        </ItemGroup>
        <ItemGroup>
            <NetPgoProject2 Include="$(MSBuildProjectDirectory)\_tst.net\_tst.net.csproj" />
        </ItemGroup>
        <ItemGroup>
            <PgoProject Include="$(MSBuildProjectDirectory)\pcre\pcre.vcxproj" />
            <PgoProject Include="$(MSBuildProjectDirectory)\argtable\argtable.vcxproj" />
            <PgoProject Include="$(MSBuildProjectDirectory)\libtomcrypt\libtomcrypt.vcxproj" />
            <PgoProject Include="$(MSBuildProjectDirectory)\apc\apc.vcxproj" />
            <PgoProject Include="$(MSBuildProjectDirectory)\hlinq\hlinq.vcxproj" />
            <PgoProject Include="$(MSBuildProjectDirectory)\_tst\_tst.vcxproj" />
        </ItemGroup>
        <ItemGroup>
            <WorkingDir Include="$(MSBuildProjectDirectory)\$(Configuration)"/>
        </ItemGroup>
        <ItemGroup>
            <WorkingDir64 Include="$(MSBuildProjectDirectory)\x64\$(Configuration)"/>
        </ItemGroup>
        <ItemGroup>
            <TargetDir Include="$(MSBuildProjectDirectory)\$(Configuration)"/>
            <TargetDir Include="$(MSBuildProjectDirectory)\x64\$(Configuration)"/>
        </ItemGroup>
        <BlockOpen Name="CompilationPGO"/>
            <MSBuild
                Projects="@(NetPgoProject1)"
                BuildInParallel="true"
                Properties="Configuration=$(Configuration);Platform=x86" />
            <MSBuild
                Projects="@(NetPgoProject2)"
                BuildInParallel="true"
                Properties="Configuration=$(Configuration);Platform=AnyCPU" />
            <MSBuild
                Projects="@(PgoProject)"
                BuildInParallel="true"
                Properties="Configuration=$(Configuration);Platform=%(Platform.Identity);SolutionDir=$(MSBuildProjectDirectory)\;LinkType=PGInstrument;MultiProcessorCompilation=$(MultiProcessorCompilation)" />
            <!-- HACK! -->
            <Copy
                SourceFiles="$(VS120COMNTOOLS)..\..\VC\bin\pgort120.dll"
                DestinationFolder="%(WorkingDir.Identity)"
            />
            <Copy
                SourceFiles="$(VS120COMNTOOLS)..\..\VC\bin\amd64\pgort120.dll"
                DestinationFolder="%(WorkingDir64.Identity)"
            />
            
            <ItemGroup>
                <Profile Include="%(WorkingDir.Identity)\*.pgc"/>
                <Profile Include="%(WorkingDir64.Identity)\*.pgc"/>
            </ItemGroup>

            
            <Delete Files="@(Profile)"/>

            <Exec Command='python.exe $(MSBuildProjectDirectory)\pgoptimize\run.py -p "%(TargetDir.Identity)"' WorkingDirectory="$(MSBuildProjectDirectory)\$(Configuration)"/>

			<ItemGroup>
				<ApcExe Include="$(MSBuildProjectDirectory)\$(Configuration)\apc.exe" />
				<ApcExe Include="$(MSBuildProjectDirectory)\x64\$(Configuration)\apc.exe" />
			</ItemGroup>
			
            <Exec Command='%(ApcExe.Identity) -f $(MSBuildProjectDirectory)\htpasswd.txt -a 0-9 -x 3' WorkingDirectory="%(ApcExe.RootDir)%(ApcExe.Directory)"/>

            <MSBuild
                Projects="@(PgoProject)"
                BuildInParallel="true"
                Properties="Configuration=$(Configuration);Platform=%(Platform.Identity);SolutionDir=$(MSBuildProjectDirectory)\;LinkType=PGOptimization;MultiProcessorCompilation=$(MultiProcessorCompilation)" />
                
        <BlockClose Name="CompilationPGO"/>
    </Target>
    <Target Name="Tests" DependsOnTargets="Compile">
        <BlockOpen Name="Unit tests"/>
		<ItemGroup>
			<TestExe Include="$(MSBuildProjectDirectory)\$(Configuration)\_tst.exe" />
			<TestExe Include="$(MSBuildProjectDirectory)\x64\$(Configuration)\_tst.exe" />
		</ItemGroup>
        <RunGoogleTests
            TestExePath="%(TestExe.Identity)"
            CatchGtestExceptions="true"
			Verbose="true"
			WhenNoDataPublished="error"
        />
    </Target>
    <Target Name="ManagedTests" DependsOnTargets="Tests">
        <!-- Managed tests -->
        <xunit Assembly="$(MSBuildProjectDirectory)\_tst.net\bin\$(Configuration)\_tst.net.dll" TeamCity="true" ShadowCopy="false" />
        <BlockClose Name="Unit tests"/>
    </Target>
    <!-- Zipping x86 symbols -->
    <Target Name="Zipping-x86" DependsOnTargets="ManagedTests">
        <BlockOpen Name="Packaging"/>
        <ItemGroup>
            <FileToZip Include="$(Configuration)\apc*.pdb" />
            <FileToZip Include="$(Configuration)\hc*.pdb" />
        </ItemGroup>
        <!-- Zipping pdb -->
        <Zip
            Files="@(FileToZip)"
            ZipFileName="$(PdbZipFile)"
            Flatten="true"
            ZipLevel="9"
            WorkingDirectory="$(MSBuildProjectDirectory)" 
        />
    </Target>
    <!-- Zipping x64 symbols -->
    <Target Name="Zipping-x64" DependsOnTargets="Zipping-x86">
        <ItemGroup>
            <x64FileToZip Include="x64\$(Configuration)\apc*.pdb" />
            <x64FileToZip Include="x64\$(Configuration)\hc*.pdb" />
        </ItemGroup>
        <!-- Zipping pdb -->
        <Zip
            Files="@(x64FileToZip)"
            ZipFileName="x64\$(PdbZipFile)"
            Flatten="true"
            ZipLevel="9"
            WorkingDirectory="$(MSBuildProjectDirectory)" 
        />
    </Target>
    <ItemGroup>
        <Binfile Include="apc"/>
        <Binfile Include="hc"/>
    </ItemGroup>
    <Target Name="Binplace" DependsOnTargets="Zipping-x64">
        <Exec 
            WorkingDirectory="$(MSBuildProjectDirectory)\$(Configuration)"
            Command='"$(BinPlacePath)\binplace.exe" -v -r $(MSBuildProjectDirectory)\Binplace-x86\$(Configuration) %(Binfile.Identity).exe'
        />
        <Exec 
            WorkingDirectory="$(MSBuildProjectDirectory)"
            Command='"$(SymStorePath)\symstore.exe" add /F $(MSBuildProjectDirectory)\Binplace-x86\$(Configuration)\%(Binfile.Identity).pdb /S "$(_NT386TREE)\sym.pri" /t "%(Binfile.Identity) calculator" /r /z pri'
        />
        <Exec 
            WorkingDirectory="$(MSBuildProjectDirectory)\x64\$(Configuration)"
            Command='"$(BinPlacePath)\binplace.exe" -v -r $(MSBuildProjectDirectory)\Binplace-x64\$(Configuration) %(Binfile.Identity).exe'
        />
        <Exec 
            WorkingDirectory="$(MSBuildProjectDirectory)"
            Command='"$(SymStorePath)\symstore.exe" add /F $(MSBuildProjectDirectory)\Binplace-x64\$(Configuration)\%(Binfile.Identity).pdb /S "$(_NTAMD64TREE)\sym.pri" /t "%(Binfile.Identity) calculator" /r /z pri'
        />
    </Target>
    <ItemGroup>
        <Installer Include="mainApc.nsi"/>
        <Installer Include="mainHLINQ.nsi"/>
    </ItemGroup>
    <Target Name="Setup" DependsOnTargets="Binplace">
        <MakeDir Directories="$(MSBuildProjectDirectory)\Install\$(Configuration)"/>
        <!-- Documentation building -->
        <Exec
            Command='"$(MSBuildProjectDirectory)\doc.gen\bin\$(Configuration)\doc.gen.exe" "$(MSBuildProjectDirectory)\..\docs"'
        />
        <Exec 
            WorkingDirectory="$(MSBuildProjectDirectory)\Install"
            Command='"$(NSISPath)\makensis.exe" /NOTIFYHWND 131948 /DConfiguration=$(Configuration) /DPRODUCT_VERSION=$(Major).$(Minor).$(Build).$(Revision) "%(Installer.Identity)"'
        />
        <BlockClose Name="Packaging"/>
    </Target>
    <ItemGroup>
        <Distributive Include="apctool" />
        <Distributive Include="hcsetup" />
    </ItemGroup>
    <Target Name="Build" DependsOnTargets="Setup">
        <BlockOpen Name="Uploading"/>
        <ItemGroup>
            <Pdb Include="$(MSBuildProjectDirectory)\$(PdbZipFile) => x86" />
            <Pdb Include="$(MSBuildProjectDirectory)\x64\$(PdbZipFile) => x64" />
        </ItemGroup>
        <PublishArtifacts Artifacts="@(Pdb)"/>
        <Message Text="Build $(Major).$(Minor).$(Build).$(Revision) Complete"/>
        <BlockClose Name="Uploading"/>
    </Target>
    
    <ItemGroup>
        <XunitTools Include="$(MSBuildProjectDirectory)\packages\xunit.runners.*\tools\xunit.runner.msbuild.dll" />
    </ItemGroup>

    <UsingTask AssemblyFile="@(XunitTools)" TaskName="Xunit.Runner.MSBuild.xunit" />
    <UsingTask TaskName="RegexTransform" TaskFactory="CodeTaskFactory" AssemblyFile="$(MSBuildToolsPath)\Microsoft.Build.Tasks.v4.0.dll">
        <ParameterGroup>
            <Items ParameterType="Microsoft.Build.Framework.ITaskItem[]" />
        </ParameterGroup>
        <Task>
            <Using Namespace="System.IO" />
            <Using Namespace="System.Text.RegularExpressions" />
            <Using Namespace="Microsoft.Build.Framework" />
            <Code Type="Fragment" Language="cs">
                <![CDATA[
			   foreach(var item in Items)
			   {
				 string fileName = item.GetMetadata("FullPath");
				 string find = item.GetMetadata("Find");
				 string replaceWith = item.GetMetadata("ReplaceWith");
				 string optionsValue = item.GetMetadata("Options") ?? "";
		 
				 var options = string.IsNullOrWhiteSpace(optionsValue) ?
					 RegexOptions.None : (RegexOptions)Enum.Parse(typeof(RegexOptions), optionsValue.Replace('|', ','));
		 
				 if(!File.Exists(fileName))
				 {
				   Log.LogError("Could not find file: {0}", fileName);
				   return false;
				 }
				 string content = File.ReadAllText(fileName);
				 File.WriteAllText(
				   fileName,
				   Regex.Replace(
					 content,
					 find,
					 replaceWith,
					 options
				   )
				 );
			   }
			 ]]>
            </Code>
        </Task>
    </UsingTask>
</Project>