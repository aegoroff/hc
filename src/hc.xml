<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
	<Import Project="$(MSBuildExtensionsPath)\MSBuildCommunityTasks\MSBuild.Community.Tasks.Targets"/>
	<!-- http://code.google.com/p/msbuildteamcitytasks/ -->
	<Import Project="$(MSBuildExtensionsPath)\MSBuildTeamCityTasks\MSBuild.TeamCity.Tasks.Targets"/>
	<PropertyGroup>
		<Configuration>Release</Configuration>
		<!-- Version components  -->
		<Major>1</Major>
		<Minor>0</Minor>
		<Build>0</Build>
		<Revision>0</Revision>
		<FtpLogin>1</FtpLogin>
		<FtpPassword>1</FtpPassword>
		<FtpFolder>ftp://somehost.com/folder</FtpFolder>
		<IsUpload>false</IsUpload>
		
		<!-- NUnit working path  -->
		<NUnitPath>C:\Program Files\NUnit 2.5.7\bin\net-2.0</NUnitPath>
		
		<!-- Managed unit tests report  -->
		<ManagedTestsReport>ManagedTests.xml</ManagedTestsReport>
	</PropertyGroup>
	<ItemGroup>
		<ResourceFile Include="$(MSBuildProjectDirectory)\md5\md5.rc" />
		<ResourceFile Include="$(MSBuildProjectDirectory)\md4\md4.rc" />
        <ResourceFile Include="$(MSBuildProjectDirectory)\sha1\sha1.rc" />
		<ResourceFile Include="$(MSBuildProjectDirectory)\sha256\sha256.rc" />
		<ResourceFile Include="$(MSBuildProjectDirectory)\sha384\sha384.rc" />
		<ResourceFile Include="$(MSBuildProjectDirectory)\sha512\sha512.rc" />
		<ResourceFile Include="$(MSBuildProjectDirectory)\whirlpool\whirlpool.rc" />
	</ItemGroup>
    <ItemGroup>
		<TargetverFile Include="$(MSBuildProjectDirectory)\md4\targetver.h" />
		<TargetverFile Include="$(MSBuildProjectDirectory)\md5\targetver.h" />
        <TargetverFile Include="$(MSBuildProjectDirectory)\sha1\targetver.h" />
		<TargetverFile Include="$(MSBuildProjectDirectory)\sha256\targetver.h" />
		<TargetverFile Include="$(MSBuildProjectDirectory)\sha384\targetver.h" />
		<TargetverFile Include="$(MSBuildProjectDirectory)\sha512\targetver.h" />
		<TargetverFile Include="$(MSBuildProjectDirectory)\whirlpool\targetver.h" />
	</ItemGroup>
	<Target Name="VersionUpdater">
		<FileUpdate
			Condition=" $(TEAMCITY_VERSION) != ''"
			Files="@(ResourceFile)"
			Regex='(FILEVERSION|PRODUCTVERSION)(\s*)(\d+),(\d+),(\d+),(\d+)'
			Encoding="windows-1251"
			ReplacementText='$1 $(Major),$(Minor),$(Build),$(Revision)' />
		<FileUpdate
			Condition=" $(TEAMCITY_VERSION) != ''"
			Files="@(ResourceFile)"
			Regex='VALUE\s*"(FileVersion|ProductVersion)",\s*"\d+([.,]\s*)\d+([.,]\s*)\d+([.,]\s*)\d+"'
			Encoding="windows-1251"
			ReplacementText='VALUE "$1", "$(Major), $(Minor), $(Build), $(Revision)"' />
		<FileUpdate
			Condition=" $(TEAMCITY_VERSION) != ''"
			Files="@(TargetverFile)"
			Regex='(#define PRODUCT_VERSION)(\s*)"(\d+).(\d+).(\d+).(\d+)"'
			Encoding="windows-1251"
			ReplacementText='$1 "$(Major).$(Minor).$(Build).$(Revision)"' />
	</Target>
	<ItemGroup>
		<BuildProperty Include="Configuration=$(Configuration);Platform=Win32"/>
		<BuildProperty Include="Configuration=$(Configuration);Platform=x64"/>
	</ItemGroup>
	<Target Name="Compile" DependsOnTargets="VersionUpdater">
		<MSBuild Projects="hc.sln" BuildInParallel="true" Properties="%(BuildProperty.Identity)" />
	</Target>
	<Target Name="Tests" DependsOnTargets="Compile">
		<RunGoogleTests
			TestExePath="$(Configuration)\_tst.exe"
			CatchGtestExceptions="true"
		/>
	</Target>
    <Target Name="ManagedTests" DependsOnTargets="Tests">
		<!-- Managed tests -->
		<Exec
			Command='"$(NUnitPath)\nunit-console.exe" /xml:$(MSBuildProjectDirectory)\$(ManagedTestsReport) _tst.net\bin\$(Configuration)\_tst.net.dll /config=$(Configuration)'
			IgnoreExitCode="true"
		/>
		<!-- Import into TeamCity mono tests -->
		<ImportData Type="nunit" Path="$(MSBuildProjectDirectory)\$(ManagedTestsReport)" />
	</Target>
	<ItemGroup>
		<Installer Include="mainMd4.nsi"/>
		<Installer Include="mainMd5.nsi"/>
		<Installer Include="mainSha1.nsi"/>
		<Installer Include="mainSha256.nsi"/>
		<Installer Include="mainSha384.nsi"/>
		<Installer Include="mainSha512.nsi"/>
		<Installer Include="mainWhirlpool.nsi"/>
		<Installer Include="mainAll.nsi"/>
	</ItemGroup>
	<Target Name="Setup" DependsOnTargets="ManagedTests">
		<MakeDir Directories="$(MSBuildProjectDirectory)\Install\$(Configuration)"/>
		<Exec 
			WorkingDirectory="$(MSBuildProjectDirectory)\Install"
			Command='"C:\Program Files\NSIS\makensis.exe" /NOTIFYHWND 131948 /DConfiguration=$(Configuration) /DArch=x86 /DPRODUCT_VERSION=$(Major).$(Minor).$(Build).$(Revision) "%(Installer.Identity)"'
		/>
		<Exec 
			WorkingDirectory="$(MSBuildProjectDirectory)\Install"
			Command='"C:\Program Files\NSIS\makensis.exe" /NOTIFYHWND 131948 /DConfiguration=$(Configuration) /DArch=x64 /DPRODUCT_VERSION=$(Major).$(Minor).$(Build).$(Revision) "%(Installer.Identity)"'
		/>
	</Target>
	<ItemGroup>
		<Distributive Include="md5calculator" />
		<Distributive Include="md4calculator" />
		<Distributive Include="sha1calculator" />
		<Distributive Include="sha256calculator" />
		<Distributive Include="sha384calculator" />
		<Distributive Include="sha512calculator" />
		<Distributive Include="whirlpoolcalculator" />
		<Distributive Include="hashcalculators" />
	</ItemGroup>
	<Target Name="Build" DependsOnTargets="Setup">
		<FtpUpload 
			LocalFile="$(MSBuildProjectDirectory)\Install\$(Configuration)\%(Distributive.Identity).exe"
			RemoteUri="$(FtpFolder)/%(Distributive.Identity).exe"
			Username="$(FtpLogin)"
			Password="$(FtpPassword)"
			Condition=" '$(IsUpload)'=='true' "
			UsePassive = 'true'
		/>
		<FtpUpload 
			LocalFile="$(MSBuildProjectDirectory)\Install\$(Configuration)\%(Distributive.Identity)-x64.exe"
			RemoteUri="$(FtpFolder)/%(Distributive.Identity)-x64.exe"
			Username="$(FtpLogin)"
			Password="$(FtpPassword)"
			Condition=" '$(IsUpload)'=='true' "
			UsePassive = 'true'
		/>
		<Message Text="Build $(Major).$(Minor).$(Build).$(Revision) Complete"/>
	</Target>
</Project>