<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
	<Import Project="$(MSBuildExtensionsPath)\MSBuildCommunityTasks\MSBuild.Community.Tasks.Targets"/>
	<!-- http://code.google.com/p/msbuildteamcitytasks/ -->
	<Import Project="$(MSBuildExtensionsPath)\MSBuildTeamCityTasks\MSBuild.TeamCity.Tasks.Targets"/>
	<PropertyGroup>
		<Configuration>Release</Configuration>
		<!-- Version components  -->
		<Major>1</Major>
		<Minor>0</Minor>
		<Build>0</Build>
		<Revision>0</Revision>
		<FtpLogin>1</FtpLogin>
		<FtpPassword>1</FtpPassword>
		<FtpFolder>ftp://somehost.com/folder</FtpFolder>
		<IsUpload>false</IsUpload>
		<BinaryArchiveMd5>$(MSBuildProjectDirectory)\Install\$(Configuration)\md5calculator.exe</BinaryArchiveMd5>
        <BinaryArchiveMd4>$(MSBuildProjectDirectory)\Install\$(Configuration)\md4calculator.exe</BinaryArchiveMd4>
        <BinaryArchiveSha1>$(MSBuildProjectDirectory)\Install\$(Configuration)\sha1calculator.exe</BinaryArchiveSha1>
		<BinaryArchiveSha256>$(MSBuildProjectDirectory)\Install\$(Configuration)\sha256calculator.exe</BinaryArchiveSha256>
		<BinaryArchiveSha384>$(MSBuildProjectDirectory)\Install\$(Configuration)\sha384calculator.exe</BinaryArchiveSha384>
		<BinaryArchiveSha512>$(MSBuildProjectDirectory)\Install\$(Configuration)\sha512calculator.exe</BinaryArchiveSha512>
		<BinaryArchiveWhirlpool>$(MSBuildProjectDirectory)\Install\$(Configuration)\whirlpoolcalculator.exe</BinaryArchiveWhirlpool>
		<BinaryArchiveAll>$(MSBuildProjectDirectory)\Install\$(Configuration)\hashcalculators.exe</BinaryArchiveAll>
		
		<!-- NUnit working path  -->
		<NUnitPath>C:\Program Files\NUnit 2.5.2\bin\net-2.0</NUnitPath>
	</PropertyGroup>
	<ItemGroup>
		<ResourceFile Include="$(MSBuildProjectDirectory)\md5\md5.rc" />
		<ResourceFile Include="$(MSBuildProjectDirectory)\md4\md4.rc" />
        <ResourceFile Include="$(MSBuildProjectDirectory)\sha1\sha1.rc" />
		<ResourceFile Include="$(MSBuildProjectDirectory)\sha256\sha256.rc" />
		<ResourceFile Include="$(MSBuildProjectDirectory)\sha384\sha384.rc" />
		<ResourceFile Include="$(MSBuildProjectDirectory)\sha512\sha512.rc" />
		<ResourceFile Include="$(MSBuildProjectDirectory)\whirlpool\whirlpool.rc" />
	</ItemGroup>
    <ItemGroup>
		<TargetverFile Include="$(MSBuildProjectDirectory)\md4\targetver.h" />
		<TargetverFile Include="$(MSBuildProjectDirectory)\md5\targetver.h" />
        <TargetverFile Include="$(MSBuildProjectDirectory)\sha1\targetver.h" />
		<TargetverFile Include="$(MSBuildProjectDirectory)\sha256\targetver.h" />
		<TargetverFile Include="$(MSBuildProjectDirectory)\sha384\targetver.h" />
		<TargetverFile Include="$(MSBuildProjectDirectory)\sha512\targetver.h" />
		<TargetverFile Include="$(MSBuildProjectDirectory)\whirlpool\targetver.h" />
	</ItemGroup>
	<Target Name="VersionUpdater">
		<FileUpdate
			Condition=" $(TEAMCITY_VERSION) != ''"
			Files="@(ResourceFile)"
			Regex='(FILEVERSION|PRODUCTVERSION)(\s*)(\d+),(\d+),(\d+),(\d+)'
			Encoding="windows-1251"
			ReplacementText='$1 $(Major),$(Minor),$(Build),$(Revision)' />
		<FileUpdate
			Condition=" $(TEAMCITY_VERSION) != ''"
			Files="@(ResourceFile)"
			Regex='VALUE\s*"(FileVersion|ProductVersion)",\s*"\d+([.,]\s*)\d+([.,]\s*)\d+([.,]\s*)\d+"'
			Encoding="windows-1251"
			ReplacementText='VALUE "$1", "$(Major), $(Minor), $(Build), $(Revision)"' />
		<FileUpdate
			Condition=" $(TEAMCITY_VERSION) != ''"
			Files="@(TargetverFile)"
			Regex='(#define PRODUCT_VERSION)(\s*)"(\d+).(\d+).(\d+).(\d+)"'
			Encoding="windows-1251"
			ReplacementText='$1 "$(Major).$(Minor).$(Build).$(Revision)"' />
	</Target>
	<ItemGroup>
		<BuildProperty Include="Configuration=$(Configuration);Platform=Win32"/>
		<BuildProperty Include="Configuration=$(Configuration);Platform=x64"/>
	</ItemGroup>
	<Target Name="Compile" DependsOnTargets="VersionUpdater">
		<MSBuild Projects="hc.sln" BuildInParallel="true" Properties="%(BuildProperty.Identity)" />
	</Target>
	<Target Name="Tests" DependsOnTargets="Compile">
		<RunGoogleTests
			TestExePath="$(Configuration)\_tst.exe"
			CatchGtestExceptions="true"
		/>
		<NUnit ToolPath="$(NUnitPath)" Assemblies="@(Assembly)"/>
	</Target>
	<!-- Assemblies list that contain unit tests -->
	<ItemGroup>
		<Assembly Include="_tst.net\bin\$(Configuration)\_tst.net.dll" />
	</ItemGroup>
    <Target Name="ManagedTests" DependsOnTargets="Tests">
		<NUnit ToolPath="$(NUnitPath)" Assemblies="@(Assembly)"/>
	</Target>
	<ItemGroup>
		<Installer Include="mainMd4.nsi"/>
		<Installer Include="mainMd5.nsi"/>
		<Installer Include="mainSha1.nsi"/>
		<Installer Include="mainSha256.nsi"/>
		<Installer Include="mainSha384.nsi"/>
		<Installer Include="mainSha512.nsi"/>
		<Installer Include="mainWhirlpool.nsi"/>
		<Installer Include="mainAll.nsi"/>
	</ItemGroup>
	<Target Name="Setup" DependsOnTargets="ManagedTests">
		<MakeDir Directories="$(MSBuildProjectDirectory)\Install\$(Configuration)"/>
		<Exec 
			WorkingDirectory="$(MSBuildProjectDirectory)\Install"
			Command='"C:\Program Files\NSIS\makensis.exe" /NOTIFYHWND 131948 /DConfiguration=$(Configuration) /DPRODUCT_VERSION=$(Major).$(Minor).$(Build).$(Revision) "%(Installer.Identity)"'
		/>
	</Target>
	<Target Name="Build" DependsOnTargets="Setup">
		<FtpUpload 
			LocalFile="$(BinaryArchiveMd5)"
			RemoteUri="$(FtpFolder)/md5calculator.exe"
			Username="$(FtpLogin)"
			Password="$(FtpPassword)"
			Condition=" '$(IsUpload)'=='true' "
			UsePassive = 'true'
		/>
        <FtpUpload 
			LocalFile="$(BinaryArchiveMd4)"
			RemoteUri="$(FtpFolder)/md4calculator.exe"
			Username="$(FtpLogin)"
			Password="$(FtpPassword)"
			Condition=" '$(IsUpload)'=='true' "
			UsePassive = 'true'
		/>
        <FtpUpload 
			LocalFile="$(BinaryArchiveSha1)"
			RemoteUri="$(FtpFolder)/sha1calculator.exe"
			Username="$(FtpLogin)"
			Password="$(FtpPassword)"
			Condition=" '$(IsUpload)'=='true' "
			UsePassive = 'true'
		/>
		<FtpUpload 
			LocalFile="$(BinaryArchiveSha256)"
			RemoteUri="$(FtpFolder)/sha256calculator.exe"
			Username="$(FtpLogin)"
			Password="$(FtpPassword)"
			Condition=" '$(IsUpload)'=='true' "
			UsePassive = 'true'
		/>
		<FtpUpload 
			LocalFile="$(BinaryArchiveSha384)"
			RemoteUri="$(FtpFolder)/sha384calculator.exe"
			Username="$(FtpLogin)"
			Password="$(FtpPassword)"
			Condition=" '$(IsUpload)'=='true' "
			UsePassive = 'true'
		/>
		<FtpUpload 
			LocalFile="$(BinaryArchiveSha512)"
			RemoteUri="$(FtpFolder)/sha512calculator.exe"
			Username="$(FtpLogin)"
			Password="$(FtpPassword)"
			Condition=" '$(IsUpload)'=='true' "
			UsePassive = 'true'
		/>
		<FtpUpload 
			LocalFile="$(BinaryArchiveWhirlpool)"
			RemoteUri="$(FtpFolder)/whirlpoolcalculator.exe"
			Username="$(FtpLogin)"
			Password="$(FtpPassword)"
			Condition=" '$(IsUpload)'=='true' "
			UsePassive = 'true'
		/>
		<FtpUpload 
			LocalFile="$(BinaryArchiveAll)"
			RemoteUri="$(FtpFolder)/hashcalculators.exe"
			Username="$(FtpLogin)"
			Password="$(FtpPassword)"
			Condition=" '$(IsUpload)'=='true' "
			UsePassive = 'true'
		/>
		<Message Text="Build $(Major).$(Minor).$(Build).$(Revision) Complete"/>
	</Target>
</Project>