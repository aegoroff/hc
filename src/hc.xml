<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
	<Import Project="$(MSBuildExtensionsPath)\MSBuildCommunityTasks\MSBuild.Community.Tasks.Targets"/>
	<!-- http://code.google.com/p/msbuildteamcitytasks/ -->
	<Import Project="$(MSBuildExtensionsPath)\MSBuildTeamCityTasks\MSBuild.TeamCity.Tasks.Targets"/>
	<PropertyGroup>
		<Configuration>Release</Configuration>
		<!-- Version components  -->
		<Major>1</Major>
		<Minor>0</Minor>
		<Build>0</Build>
		<Revision>0</Revision>
		<FtpLogin>1</FtpLogin>
		<FtpPassword>1</FtpPassword>
		<FtpFolder>ftp://somehost.com/folder</FtpFolder>
		<IsUpload>false</IsUpload>
		
		<!-- NUnit working path  -->
		<NUnitPath>C:\Program Files\NUnit 2.5.7\bin\net-2.0</NUnitPath>
		
		<!-- NSIS installer's path  -->
		<NSISPath>C:\Program Files\NSIS</NSISPath>
		
		<!-- binplace utility path  -->
		<BinPlacePath>C:\WinDDK\6001.18001\bin\x86</BinPlacePath>
		
		<!-- Managed unit tests report  -->
		<ManagedTestsReport>ManagedTests.xml</ManagedTestsReport>
		
		<x86ExeFileSuffix>.exe</x86ExeFileSuffix>
		<PdbZipFile>Pdb.zip</PdbZipFile>
	</PropertyGroup>
	<ItemGroup>
		<ResourceFile Include="$(MSBuildProjectDirectory)\md5\md5.rc" />
		<ResourceFile Include="$(MSBuildProjectDirectory)\md4\md4.rc" />
        <ResourceFile Include="$(MSBuildProjectDirectory)\sha1\sha1.rc" />
		<ResourceFile Include="$(MSBuildProjectDirectory)\sha256\sha256.rc" />
		<ResourceFile Include="$(MSBuildProjectDirectory)\sha384\sha384.rc" />
		<ResourceFile Include="$(MSBuildProjectDirectory)\sha512\sha512.rc" />
		<ResourceFile Include="$(MSBuildProjectDirectory)\crc32\crc32.rc" />
		<ResourceFile Include="$(MSBuildProjectDirectory)\whirlpool\whirlpool.rc" />
		<ResourceFile Include="$(MSBuildProjectDirectory)\htpwdc\htpwdc.rc" />
	</ItemGroup>
    <ItemGroup>
		<TargetverFile Include="$(MSBuildProjectDirectory)\md4\targetver.h" />
		<TargetverFile Include="$(MSBuildProjectDirectory)\md5\targetver.h" />
        <TargetverFile Include="$(MSBuildProjectDirectory)\sha1\targetver.h" />
		<TargetverFile Include="$(MSBuildProjectDirectory)\sha256\targetver.h" />
		<TargetverFile Include="$(MSBuildProjectDirectory)\sha384\targetver.h" />
		<TargetverFile Include="$(MSBuildProjectDirectory)\sha512\targetver.h" />
		<TargetverFile Include="$(MSBuildProjectDirectory)\crc32\targetver.h" />
		<TargetverFile Include="$(MSBuildProjectDirectory)\whirlpool\targetver.h" />
		<TargetverFile Include="$(MSBuildProjectDirectory)\htpwdc\targetver.h" />
	</ItemGroup>
	<Target Name="VersionUpdater">
		<BlockOpen Name="Preparation"/>
		<FileUpdate
			Condition=" $(TEAMCITY_VERSION) != ''"
			Files="@(ResourceFile)"
			Regex='(FILEVERSION|PRODUCTVERSION)(\s*)(\d+),(\d+),(\d+),(\d+)'
			Encoding="windows-1251"
			ReplacementText='$1 $(Major),$(Minor),$(Build),$(Revision)' />
		<FileUpdate
			Condition=" $(TEAMCITY_VERSION) != ''"
			Files="@(ResourceFile)"
			Regex='VALUE\s*"(FileVersion|ProductVersion)",\s*"\d+([.,]\s*)\d+([.,]\s*)\d+([.,]\s*)\d+"'
			Encoding="windows-1251"
			ReplacementText='VALUE "$1", "$(Major), $(Minor), $(Build), $(Revision)"' />
		<FileUpdate
			Condition=" $(TEAMCITY_VERSION) != ''"
			Files="@(TargetverFile)"
			Regex='(#define PRODUCT_VERSION)(\s*)"(\d+).(\d+).(\d+).(\d+)"'
			Encoding="windows-1251"
			ReplacementText='$1 "$(Major).$(Minor).$(Build).$(Revision)"' />
		<BlockClose Name="Preparation"/>
	</Target>
	<ItemGroup>
		<Platform Include="Win32"/>
		<Platform Include="x64"/>
	</ItemGroup>
	<Target Name="Compile" DependsOnTargets="VersionUpdater">
		<BlockOpen Name="Compilation"/>
		<MSBuild Projects="hc.sln" BuildInParallel="true" Properties="Configuration=$(Configuration);Platform=%(Platform.Identity)" />
		<BlockClose Name="Compilation"/>
	</Target>
	<Target Name="Tests" DependsOnTargets="Compile">
		<BlockOpen Name="Unit tests"/>
		<RunGoogleTests
			TestExePath="$(Configuration)\_tst.exe"
			CatchGtestExceptions="true"
		/>
	</Target>
    <Target Name="ManagedTests" DependsOnTargets="Tests">
		<!-- Managed tests -->
		<Exec
			Command='"$(NUnitPath)\nunit-console.exe" /xml:$(MSBuildProjectDirectory)\$(ManagedTestsReport) _tst.net\bin\$(Configuration)\_tst.net.dll /config=$(Configuration)'
			IgnoreExitCode="true"
		/>
		<!-- Import into TeamCity mono tests -->
		<ImportData Type="nunit" Path="$(MSBuildProjectDirectory)\$(ManagedTestsReport)" />
		<BlockClose Name="Unit tests"/>
	</Target>
	<!-- Zipping x86 symbols -->
	<Target Name="Zipping-x86" DependsOnTargets="ManagedTests">
		<BlockOpen Name="Packaging"/>
		<ItemGroup>
			<FileToZip Include="$(Configuration)\md*.pdb" />
			<FileToZip Include="$(Configuration)\sha*.pdb" />
			<FileToZip Include="$(Configuration)\crc*.pdb" />
			<FileToZip Include="$(Configuration)\htpwdc*.pdb" />
			<FileToZip Include="$(Configuration)\whirlpool*.pdb" />
		</ItemGroup>
		<!-- Zipping pdb -->
		<Zip
			Files="@(FileToZip)"
			ZipFileName="$(PdbZipFile)"
			Flatten="true"
			ZipLevel="9"
			WorkingDirectory="$(MSBuildProjectDirectory)" 
		/>
	</Target>
	<!-- Zipping x64 symbols -->
	<Target Name="Zipping-x64" DependsOnTargets="Zipping-x86">
		<ItemGroup>
			<x64FileToZip Include="x64\$(Configuration)\md*.pdb" />
			<x64FileToZip Include="x64\$(Configuration)\sha*.pdb" />
			<x64FileToZip Include="x64\$(Configuration)\crc*.pdb" />
			<x64FileToZip Include="x64\$(Configuration)\whirlpool*.pdb" />
			<x64FileToZip Include="x64\$(Configuration)\htpwdc*.pdb" />
		</ItemGroup>
		<!-- Zipping pdb -->
		<Zip
			Files="@(x64FileToZip)"
			ZipFileName="x64\$(PdbZipFile)"
			Flatten="true"
			ZipLevel="9"
			WorkingDirectory="$(MSBuildProjectDirectory)" 
		/>
	</Target>
	<ItemGroup>
		<Binfile Include="md4"/>
		<Binfile Include="md5"/>
		<Binfile Include="sha1"/>
		<Binfile Include="sha256"/>
		<Binfile Include="sha384"/>
		<Binfile Include="sha512"/>
		<Binfile Include="crc32"/>
		<Binfile Include="whirlpool"/>
		<Binfile Include="htpwdc"/>
	</ItemGroup>
	<Target Name="Binplace" DependsOnTargets="Zipping-x64">
		<Exec 
			WorkingDirectory="$(MSBuildProjectDirectory)\$(Configuration)"
			Command='"$(BinPlacePath)\binplace.exe" -v -r $(MSBuildProjectDirectory)\Binplace-x86\$(Configuration) %(Binfile.Identity).exe'
		/>
		<Exec 
			WorkingDirectory="$(MSBuildProjectDirectory)"
			Command='"symstore.exe" add /F $(MSBuildProjectDirectory)\Binplace-x86\$(Configuration)\%(Binfile.Identity).pdb /S $(_NT386TREE)\sym.pri /t "%(Binfile.Identity) calculator" /r /z pri'
		/>
		<Exec 
			WorkingDirectory="$(MSBuildProjectDirectory)\x64\$(Configuration)"
			Command='"$(BinPlacePath)\binplace.exe" -v -r $(MSBuildProjectDirectory)\Binplace-x64\$(Configuration) %(Binfile.Identity).exe'
		/>
		<Exec 
			WorkingDirectory="$(MSBuildProjectDirectory)"
			Command='"symstore.exe" add /F $(MSBuildProjectDirectory)\Binplace-x64\$(Configuration)\%(Binfile.Identity).pdb /S $(_NTAMD64TREE)\sym.pri /t "%(Binfile.Identity) calculator" /r /z pri'
		/>
		<!-- CRC32 hack because binplace cannot work with file name crc32 -->
		<Copy
			SourceFiles="$(MSBuildProjectDirectory)\$(Configuration)\crc32.exe"
			DestinationFolder="$(MSBuildProjectDirectory)\Binplace-x86\$(Configuration)"
		/>
		<Copy
			SourceFiles="$(MSBuildProjectDirectory)\x64\$(Configuration)\crc32.exe"
			DestinationFolder="$(MSBuildProjectDirectory)\Binplace-x64\$(Configuration)"
		/>
	</Target>
	<ItemGroup>
		<Installer Include="mainMd4.nsi"/>
		<Installer Include="mainMd5.nsi"/>
		<Installer Include="mainSha1.nsi"/>
		<Installer Include="mainSha256.nsi"/>
		<Installer Include="mainSha384.nsi"/>
		<Installer Include="mainSha512.nsi"/>
		<Installer Include="mainCrc32.nsi"/>
		<Installer Include="mainWhirlpool.nsi"/>
		<Installer Include="mainAll.nsi"/>
		<Installer Include="mainApc.nsi"/>
	</ItemGroup>
	<Target Name="Setup" DependsOnTargets="Binplace">
		<MakeDir Directories="$(MSBuildProjectDirectory)\Install\$(Configuration)"/>
		<!-- Documentation building -->
		<Exec
			Command='"$(MSBuildProjectDirectory)\doc.gen\bin\$(Configuration)\doc.gen.exe" "$(MSBuildProjectDirectory)\..\docs"'
		/>
		<Exec 
			WorkingDirectory="$(MSBuildProjectDirectory)\Install"
			Command='"$(NSISPath)\makensis.exe" /NOTIFYHWND 131948 /DConfiguration=$(Configuration) /DPRODUCT_VERSION=$(Major).$(Minor).$(Build).$(Revision) "%(Installer.Identity)"'
		/>
		<BlockClose Name="Packaging"/>
	</Target>
	<ItemGroup>
		<Distributive Include="md5calculator" />
		<Distributive Include="md4calculator" />
		<Distributive Include="sha1calculator" />
		<Distributive Include="sha256calculator" />
		<Distributive Include="sha384calculator" />
		<Distributive Include="sha512calculator" />
		<Distributive Include="crc32calculator" />
		<Distributive Include="whirlpoolcalculator" />
		<Distributive Include="hashcalculators" />
	</ItemGroup>
	<Target Name="Build" DependsOnTargets="Setup">
		<BlockOpen Name="Uploading"/>
		<FtpUpload 
			LocalFile="$(MSBuildProjectDirectory)\Install\$(Configuration)\%(Distributive.Identity)$(x86ExeFileSuffix)"
			RemoteUri="$(FtpFolder)/%(Distributive.Identity)$(x86ExeFileSuffix)"
			Username="$(FtpLogin)"
			Password="$(FtpPassword)"
			Condition=" '$(IsUpload)'=='true' "
			UsePassive = 'true'
		/>
		<ItemGroup>
			<Pdb Include="$(MSBuildProjectDirectory)\$(PdbZipFile) => x86" />
			<Pdb Include="$(MSBuildProjectDirectory)\x64\$(PdbZipFile) => x64" />
		</ItemGroup>
		<PublishArtifacts Artifacts="@(Pdb)"/>
		<Message Text="Build $(Major).$(Minor).$(Build).$(Revision) Complete"/>
		<BlockClose Name="Uploading"/>
	</Target>
</Project>