<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
	<Import Project="$(MSBuildExtensionsPath)\MSBuildCommunityTasks\MSBuild.Community.Tasks.Targets"/>
	<!-- http://code.google.com/p/msbuildteamcitytasks/ -->
	<Import Project="$(MSBuildExtensionsPath)\MSBuildTeamCityTasks\MSBuild.TeamCity.Tasks.Targets"/>
	<PropertyGroup>
		<Configuration>Release</Configuration>
		<!-- Version components  -->
		<Major>1</Major>
		<Minor>0</Minor>
		<Build>0</Build>
		<Revision>0</Revision>
		<FtpLogin>1</FtpLogin>
		<FtpPassword>1</FtpPassword>
		<FtpFolder>ftp://somehost.com/folder</FtpFolder>
		<IsUpload>false</IsUpload>
		<BinaryArchive>$(MSBuildProjectDirectory)\Install\$(Configuration)\md5calculator.exe</BinaryArchive>
	</PropertyGroup>
	<ItemGroup>
		<ResourceFile Include="$(MSBuildProjectDirectory)\md5\md5.rc" />
	</ItemGroup>
	<Target Name="VersionUpdater">
		<FileUpdate
			Files="@(ResourceFile)"
			Regex='(FILEVERSION|PRODUCTVERSION)(\s*)(\d+),(\d+),(\d+),(\d+)'
			Encoding="windows-1251"
			ReplacementText='$1 $(Major),$(Minor),$(Build),$(Revision)' />
		<FileUpdate
			Files="@(ResourceFile)"
			Regex='VALUE\s*"(FileVersion|ProductVersion)",\s*"\d+([.,]\s*)\d+([.,]\s*)\d+([.,]\s*)\d+"'
			Encoding="windows-1251"
			ReplacementText='VALUE "$1", "$(Major)$2$(Minor)$3$(Build)$4$(Revision)"' />
	</Target>
	<Target Name="Compile" DependsOnTargets="VersionUpdater">
		<MSBuild Projects="pg.sln" Properties="Configuration=$(Configuration);Platform=Win32" />
	</Target>
	<Target Name="Setup" DependsOnTargets="Compile">
		<MakeDir Directories="$(MSBuildProjectDirectory)\Install\$(Configuration)"/>
		<Exec 
			WorkingDirectory="$(MSBuildProjectDirectory)\Install"
			Command='"C:\Program Files\NSIS\makensis.exe" /NOTIFYHWND 131948 /DConfiguration=$(Configuration) /DPRODUCT_VERSION=$(Major).$(Minor).$(Build).$(Revision) "main.nsi"'
		/>
	</Target>
	<Target Name="Build" DependsOnTargets="Setup">
		<FtpUpload 
			LocalFile="$(BinaryArchive)"
			RemoteUri="$(FtpFolder)/md5calculator.exe"
			Username="$(FtpLogin)"
			Password="$(FtpPassword)"
			Condition=" '$(IsUpload)'=='true' "
		/>
		<Message Text="Build $(Major).$(Minor).$(Build).$(Revision) Complete"/>
	</Target>
</Project>