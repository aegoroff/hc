<?xml version="1.0" encoding="utf-8"?>
<Project DefaultTargets="Build" ToolsVersion="4.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">
	<Import Project="$(MSBuildExtensionsPath)\MSBuildCommunityTasks\MSBuild.Community.Tasks.Targets"/>
	<!-- http://code.google.com/p/msbuildteamcitytasks/ -->
	<Import Project="$(MSBuildExtensionsPath)\MSBuildTeamCityTasks\MSBuild.TeamCity.Tasks.Targets"/>
	<PropertyGroup>
		<Configuration>Release</Configuration>
		<!-- Version components  -->
		<Major>1</Major>
		<Minor>0</Minor>
		<Build>0</Build>
		<Revision>0</Revision>
		<FtpLogin>1</FtpLogin>
		<FtpPassword>1</FtpPassword>
		<FtpFolder>ftp://somehost.com/folder</FtpFolder>
		<IsUpload>false</IsUpload>
		<BinaryArchive>$(MSBuildProjectDirectory)\Install\$(Configuration)\md5calculator.exe</BinaryArchive>
		<TestsFileNameWithoutExt>pgt</TestsFileNameWithoutExt>
		<ProjectName>md5</ProjectName>
		<TargetName>$(ProjectName)</TargetName>
		<Source>md5\md5.c md5\DebugHelplers.c pg\pglib.c</Source>
		<Apr>"$(APR_HOME)\apr\LibR\apr-1.lib" "$(APR_HOME)\apr-util\LibR\aprutil-1.lib" "$(APR_HOME)\apr-iconv\LibR\apriconv-1.lib"</Apr>
		<AprInc>-I"$(APR_HOME)\apr\include" -I"$(APR_HOME)\apr-util\include" -I"$(APR_HOME)\apr-iconv\include"</AprInc>
		<SdkLib>"$(PLATFORMSDK)\Lib"\Uuid.lib "$(PLATFORMSDK)\Lib\Kernel32.lib" "$(PLATFORMSDK)\Lib\Ws2_32.lib" "$(PLATFORMSDK)\Lib\AdvAPI32.Lib" "$(PLATFORMSDK)\Lib\AdvAPI32.Lib"</SdkLib>
		<IntelLib>"$(ICPP_COMPILER11)lib\ia32\libmmt.lib" "$(ICPP_COMPILER11)lib\ia32\libirc.lib" "$(ICPP_COMPILER11)lib\ia32\svml_disp.lib" "$(ICPP_COMPILER11)lib\ia32\libdecimal.lib"</IntelLib>
	</PropertyGroup>
	<ItemGroup>
		<ResourceFile Include="$(MSBuildProjectDirectory)\md5\md5.rc" />
        <ResourceFile Include="$(MSBuildProjectDirectory)\sha1\sha1.rc" />
	</ItemGroup>
    <ItemGroup>
		<TargetverFile Include="$(MSBuildProjectDirectory)\md5\targetver.h" />
        <TargetverFile Include="$(MSBuildProjectDirectory)\sha1\targetver.h" />
	</ItemGroup>
	<Target Name="VersionUpdater">
		<FileUpdate
			Condition=" $(TEAMCITY_VERSION) != ''"
			Files="@(ResourceFile)"
			Regex='(FILEVERSION|PRODUCTVERSION)(\s*)(\d+),(\d+),(\d+),(\d+)'
			Encoding="windows-1251"
			ReplacementText='$1 $(Major),$(Minor),$(Build),$(Revision)' />
		<FileUpdate
			Condition=" $(TEAMCITY_VERSION) != ''"
			Files="@(ResourceFile)"
			Regex='VALUE\s*"(FileVersion|ProductVersion)",\s*"\d+([.,]\s*)\d+([.,]\s*)\d+([.,]\s*)\d+"'
			Encoding="windows-1251"
			ReplacementText='VALUE "$1", "$(Major), $(Minor), $(Build), $(Revision)"' />
		<FileUpdate
			Condition=" $(TEAMCITY_VERSION) != ''"
			Files="@(TargetverFile)"
			Regex='(#define PRODUCT_VERSION)(\s*)"(\d+).(\d+).(\d+).(\d+)"'
			Encoding="windows-1251"
			ReplacementText='$1 "$(Major).$(Minor).$(Build).$(Revision)"' />
	</Target>
	<Target Name="Compile" DependsOnTargets="VersionUpdater">
		<MSBuild Projects="pg.sln" Properties="Configuration=$(Configuration);Platform=Win32" />
		<MSBuild Projects="pg.sln" Properties="Configuration=$(Configuration);Platform=x64" />
		<Exec
			Condition=" '$(ICPP_COMPILER11)'!='' And $(TEAMCITY_VERSION) == ''"
			WorkingDirectory="$(MSBuildProjectDirectory)"
			Command='"$(ICPP_COMPILER11)bin\ia32\icl.exe" /O3 /Qprec-div /QxSSE3 /DWIN32 /DAPR_DECLARE_STATIC /DAPU_DECLARE_STATIC /DAPI_DECLARE_STATIC -I "$(PLATFORMSDK)\Include" $(AprInc) -I"$(MSBuildProjectDirectory)\pg" /Fe$(MSBuildProjectDirectory)\$(Configuration)\icl\$(TargetName).exe $(Source) $(IntelLib) $(Apr) $(SdkLib)'
		/>
	</Target>
	<Target Name="Tests" DependsOnTargets="Compile">
		<Exec Command="$(Configuration)\$(TestsFileNameWithoutExt).exe --gtest_catch_exceptions --gtest_output=xml:" Timeout="30000" IgnoreExitCode="true"/>
		<ImportGoogleTests ContinueOnFailures="false" TestResultsPath="$(MSBuildProjectDirectory)\$(TestsFileNameWithoutExt).xml"/>
	</Target>
	<Target Name="Setup" DependsOnTargets="Tests">
		<MakeDir Directories="$(MSBuildProjectDirectory)\Install\$(Configuration)"/>
		<Exec 
			WorkingDirectory="$(MSBuildProjectDirectory)\Install"
			Command='"C:\Program Files\NSIS\makensis.exe" /NOTIFYHWND 131948 /DConfiguration=$(Configuration) /DPRODUCT_VERSION=$(Major).$(Minor).$(Build).$(Revision) "main.nsi"'
		/>
	</Target>
	<Target Name="Build" DependsOnTargets="Setup">
		<FtpUpload 
			LocalFile="$(BinaryArchive)"
			RemoteUri="$(FtpFolder)/md5calculator.exe"
			Username="$(FtpLogin)"
			Password="$(FtpPassword)"
			Condition=" '$(IsUpload)'=='true' "
			UsePassive = 'true'
		/>
		<Message Text="Build $(Major).$(Minor).$(Build).$(Revision) Complete"/>
	</Target>
</Project>